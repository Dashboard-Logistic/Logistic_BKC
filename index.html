function doGet() {
  return HtmlService.createTemplateFromFile('index').evaluate()
  .setTitle("Dashboard Logistic")
  .setFaviconUrl("https://img2.pic.in.th/pic/LOgistic.png")
  .addMetaTag('viewport', 'width=device-width, initial-scale=1')
  .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
}

/** @Get URL */
function getURL() {
  return ScriptApp.getService().getUrl();
}

/**ดึงไฟล์ */
function include(filename){
  return HtmlService.createHtmlOutputFromFile(filename).getContent()
}

function getData(sh) {
  return ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sh).getDataRange().getDisplayValues().slice(2)
}

function getDataApp(sh) {
  return ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sh).getDataRange().getDisplayValues().slice(1).filter(r=>r[1]=="รออนุมัติ")
}

function saveData(cart,fname,dpm) {
  var bookno = uuid()
  var pad = "00000"; //จำนวนหลักที่คาดว่ามีคนเข้าใช้งาน
  var runid = pad.substring(0, pad.length - bookno.length) + bookno;
  const date = new Date()
  const result = date.toLocaleDateString('th-TH', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
})
 const ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('LogProduct');
 var msg = "แจ้งผลรายการขอเบิกวัสดุสำนักงาน" + 
            "\n📍 เลขที่ : " +"JP67/"+runid+
            "\n📍 ชื่อ-สกุล : " + fname +
            "\n📍 หน่วยงาน : " + dpm +
            "\n"
  cart.forEach(r => {
    ss.appendRow([
      "",
      "รออนุมัติ",
      result,
      "JP67/"+runid,
      fname,
      dpm,
      "'"+r.id,
      r.name,
      r.unix,
      r.count,      
    ]);
  msg = msg + "\n📍 รหัสวัสดุ : " + r.id + " \n📝 รายการ : " + r.name +  " จำนวน " + r.count+ " " + r.unix 
  })
  var token = tokenID
  sendNotify(msg,token)
}


function toGoogleSheets(obj){
   const ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Product');
  var data = ss.getDataRange().getValues();
  var indexName = data.map(d => d[0]);
  var position = indexName.indexOf(obj.data1);
  if(position > -1){ 
    ss.getRange(position+1,5).setValue(obj.data2); 
  }
  return true;
}

function saveEditApp(id){
var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('LogProduct') //change
var data = ss.getDataRange().getDisplayValues()
 let rowID = data.findIndex(r =>r[0]==id)+1
  if(rowID >1){
    ss.getRange(rowID,2).setValue('อนุมัติ')
  }
 }

 function saveEditApp2(id) {
  var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("LogProduct")
  let data = ss.getDataRange().getDisplayValues()
  let rowID = data.findIndex(r => r[0] == id)+1
  if (rowID > 1) {
    //ss.deleteRow(rowID);
    ss.getRange(rowID,2).setValue('ไม่อนุมัติ')
    ss.getRange(rowID,10).setValue('0')
  }
}

 function deleteDataApp(id) {
  var ss = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("LogProduct")
  let data = ss.getDataRange().getDisplayValues()
  let rowID = data.findIndex(r => r[0] == id)+1
  if (rowID > 0) {
    ss.deleteRow(rowID);
  }
  return true;
}
